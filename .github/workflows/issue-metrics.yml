name: Monthly Issue Metrics

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch: 

permissions:
  issues: write
  pull-requests: read

jobs:
  issue-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Get dates for last month
        shell: bash
        run: |
          # Get first day of last month
          first_day=$(date -d "last month" +%Y-%m-01)
          # Get last day of last month
          last_day=$(date -d "$first_day +1 month -1 day" +%Y-%m-%d)
          
          # Set as environment variables
          echo "FIRST_DAY=$first_day" >> $GITHUB_ENV
          echo "LAST_DAY=$last_day" >> $GITHUB_ENV

      - name: Run issue-metrics tool
        uses: github/issue-metrics@v3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SEARCH_QUERY: 'repo:${{ github.repository }} is:issue created:${{ env.FIRST_DAY }}..${{ env.LAST_DAY }}'

      - name: Create report issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const metrics = fs.readFileSync('issue_metrics.md', 'utf8');
            
            const title = "ðŸ“Š Issue Metrics Report - " + process.env.FIRST_DAY + " to " + process.env.LAST_DAY;
            const body = metrics + "\n\n---\n*This report was automatically generated by the [issue-metrics](https://github.com/github/issue-metrics) action.*";

            await github.rest.issues.create({

              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['metrics', 'automated']
            });
